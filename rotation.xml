<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<rotation class="Warrior" name="Fury Rage conservative stance dancing">
	<!-- 
	Spell evaluation:
	<cast_if name="">
	Must specify a name. Is attempted to be cast if specified conditions are met. There is an implied condition that spell must be castable that exact instant.	
	This implied condition evaluates to true if resources >= resource cost, not on gcd (if ability restricted to gcd), not on spell cd, in correct stance/form, etc.
	If no conditions are specified only this implied condition is used.	

	Logic operators ("and"/"or") must be used to chain conditions if a <cast_if> has more than a single condition.	


	Built-in variables:
	melee_attacking - whether player is melee attacking.
	target_health - percentage hp remaining.
	time_remaining_encounter - time remaining in encounter.
	time_remaining_execute - time remaining to Execute phase.
	time_remaining_mh_swing - time remaining to next MH swing.
	
	State:
	In order to simplify conditions variables can be used to implement state.
	This is mostly (only?) useful for non-instant attacks, such as Heroic Strike.

	TODO: Consider how to set trigger to change variable value.

	Order is significant in this file, first <cast_if> has highest priority.
	Remember to evaluate non-GCD abilities first, as the rotation is re-run if player was not put on GCD by (non-empty) action.
	
	rotation = QVector<Action*>
	Action* action = rotation.takeFirstTrue();
	while (action != nullptr) {
		action->perform();
		action = rotation.takeFirstTrue();
	}
	
	-->
	<description>
	<!-- TODO: When displaying description, prepend to this string something along the lines of:
	"NOTE: The following description was manually written, double check that the rotation is closely matching the description."
	
	qDebug() << rotation.dump_prerequisites();
	
	Then perhaps add a simplified output in python-style of what the rotation has been interpreted to be.
	
	for (int i = 0; i < actions.size(); ++i) {
		qDebug() << actions[i]->dump_printable_conditions();
	}
	-->
	A rotation that attempts to heavily conserve rage when stance dancing.

	This implies fewer Overpowers are cast since Overpower is more likely to not always be consumed before proccing again,
	but it also implies less rage lost from stance dancing.

	Better for lower item levels due to less rage available, and thus rage conservation is more important.
	</description>
	<define_vars>
		<let variable="dumping_rage_before_stancing" equal="false"/>
		<let variable="execute_dagger_switch" equal="false"/>
	</define_vars>
	
	<prerequisites>
		<talent name="Bloodthirst"/>
		<patch_at_least name="1.5.0"/>
		<patch_at_most name="1.12.1"/>
	</prerequisites>
	
	<cast_if name="Battle Shout">
		buff "Battle Shout" less 3
	</cast_if>
	
	<!-- General heroic strike usage -->
	<cast_if name="Heroic Strike">
		variable "time_remaining_execute" greater 3
		and resource "Rage" greater 50
	</cast_if>

	<!-- Special heroic strike usage: attempt to dump rage when Overpower is up. -->
	<cast_if name="Heroic Strike" let="dumping_rage_before_stancing" equal="false">
		variable "time_remaining_execute" greater 3
		and resource "Rage" greater 30
		and buff "Overpower" greater 3
		and buff "Battle Stance" is false
		and spell "Mainhand Attack" less 1.5

		let "dumping_rage_before_stancing" = true
	</cast_if>
	
	<!-- Always cast Execute if available (implicit condition). -->
	<cast_if name="Execute"/>
	
	<!-- Always cast Bloodthirst if not in Execute range. -->
	<cast_if name="Bloodthirst">
		variable "time_remaining_execute" greater 0
	</cast_if>
	
	<!-- Whirlwind only if Bloodthirst on cooldown and not in Execute phase. -->
	<cast_if name="Whirlwind">
		spell "Bloodthirst" greater 1.5
		and variable "time_remaining_execute" greater 0
	</cast_if>
	
	<!-- Always cast Overpower if available. The implied condition checks that player is in correct stance, Overpower is active, etc. -->
	<cast_if name="Overpower"/>
	
	<!-- Switch to Battle Stance -->
	<cast_if name="Battle Stance">
		variable "time_remaining_execute" greater 5
		and buff "Overpower" greater 2
		and spell "Bloodthirst" cooldown greater 3
		and resource "Rage" less 50
		and variable "dumping_rage_before_stancing" is false
	</cast_if>

	<cast_if name="Berserker Stance">
		variable "time_remaining_execute" less 0
		or buff "Overpower" is false
	</cast_if>

	<!-- Switch to dagger set before Execute (if user specified one) -->
	<cast_if name="Execute Dagger Switch">
		variable "time_remaining_execute" less 3
		and variable "execute_dagger_switch" is false

		let "execute_dagger_switch" = true
	</cast_if>
</rotation>